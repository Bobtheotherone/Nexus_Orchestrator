# Security workflow â€” orchestrator repo (local-first)
#
# File: .github/workflows/security.yml
# Last updated: 2026-02-12
#
# Purpose
# - Catch secrets, vulnerable dependencies, and basic supply-chain issues early.
#
# What should be included
# - Secret scanning (patterns + entropy checks) with explicit allowlist for .env.example.
# - Dependency vulnerability scanning (pip-audit, osv-scanner, etc.) with pinned tool versions.
# - Optional SAST/lint rules for common Python security footguns.
# - License scanning (optional, depending on policy).
#
# Functional requirements
# - Must run without privileged credentials.
# - Must treat newly introduced secrets as a hard failure.
# - Must treat critical/high vulns as a hard failure (configurable).
#
# Non-functional requirements
# - Keep false positives manageable via documented allowlists.
# - Produce machine-readable reports (SARIF/JSON) where feasible.
#
# Security scanning
name: Security

"on":
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'  # Weekly Monday 6am

# Requirements:
# - Secret scanning on diffs
# - Dependency vulnerability scanning
# - Must fail on high-severity findings
# - Must not leak secrets in logs

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install scanners and project dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -e ".[dev]"
          python -m pip check

          GITLEAKS_VERSION=8.24.2
          curl -sSL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -o gitleaks.tar.gz
          mkdir -p "$HOME/.local/bin"
          tar -xzf gitleaks.tar.gz -C "$HOME/.local/bin" gitleaks
          chmod +x "$HOME/.local/bin/gitleaks"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Prepare security reports
        run: mkdir -p .security-reports

      - name: Run gitleaks on introduced commits (push)
        if: github.event_name == 'push' && github.event.before != '0000000000000000000000000000000000000000'
        run: |
          gitleaks git \
            --log-opts "${{ github.event.before }}..${{ github.sha }}" \
            --report-format json \
            --report-path .security-reports/gitleaks.json \
            --exit-code 0

      - name: Run full gitleaks scan (schedule/fallback)
        if: github.event_name != 'push' || github.event.before == '0000000000000000000000000000000000000000'
        run: |
          gitleaks detect \
            --source . \
            --report-format json \
            --report-path .security-reports/gitleaks.json \
            --exit-code 0

      - name: Enforce secret policy (allow .env.example)
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import sys

          report_path = ".security-reports/gitleaks.json"
          findings = []
          if os.path.exists(report_path):
              with open(report_path, "r", encoding="utf-8") as fh:
                  findings = json.load(fh) or []

          allowlisted_path = re.compile(r"(^|/)\.env\.example$")

          actionable = []
          for finding in findings:
              file_path = (finding.get("File") or "").replace("\\\\", "/")
              if allowlisted_path.search(file_path):
                  continue
              actionable.append(finding)

          if actionable:
              print(f"Detected {len(actionable)} potential secret(s) outside allowlist.")
              for finding in actionable[:20]:
                  print(
                      f"- {finding.get('RuleID', '<rule>')}: "
                      f"{finding.get('File', '<unknown>')}:{finding.get('StartLine', '?')}"
                  )
              sys.exit(1)

          print("No non-allowlisted secrets detected.")
          PY

      - name: Run dependency audit
        run: |
          python -m pip_audit \
            --strict \
            --skip-editable \
            --progress-spinner off \
            --format json \
            --output .security-reports/pip-audit.json

      - name: Upload security reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}-${{ github.run_attempt }}
          path: .security-reports/
          if-no-files-found: ignore
          retention-days: 7
