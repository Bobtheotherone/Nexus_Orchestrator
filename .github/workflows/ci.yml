# CI workflow â€” orchestrator repo (local-first)
#
# File: .github/workflows/ci.yml
# Last updated: 2026-02-12
#
# Purpose
# - Provide fast, deterministic feedback for changes to the orchestrator itself.
# - Enforce baseline quality gates *without* turning this repo into a distributable SaaS product.
#
# What should be included in this workflow
# - Jobs for: lint/format, typecheck, unit tests, integration tests, smoke tests (mocked providers).
# - Schema validation for: orchestrator config, constraint registry, evidence ledger.
# - Caching for Python deps to keep runtime low on a single workstation CI runner.
#
# Functional requirements
# - Must NOT require real provider API keys; all CI must run with mocks/fakes.
# - Must fail the PR on must-severity constraint violations for this repo (style/type/tests/security checks).
# - Must publish minimal artifacts (logs, coverage) to aid debugging.
#
# Non-functional requirements
# - Keep runtime reasonable (target: < 10 minutes on GitHub-hosted runners).
# - Deterministic outputs (pin tool versions; avoid time-dependent snapshots unless fixed).
# - Avoid flaky tests; quarantine flakes immediately.
#
# CI pipeline for the orchestrator repo itself
name: CI

"on":
  push:
  pull_request:

# Requirements:
# - Fast job: lint + typecheck (<2 min)
# - Test job: unit + integration with mocked providers (<5 min)
# - No GPU required in CI; GPU tests are optional/mocked
# - Cache dependencies aggressively
# - Deterministic: mirrors local constraint gate

permissions:
  contents: read

jobs:
  gates:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -e ".[dev]"
          python -m pip check

      - name: Prepare CI logs
        run: mkdir -p .ci-logs

      - name: Ruff check
        run: |
          set -o pipefail
          python -m ruff check src/ tests/ | tee .ci-logs/ruff-check.log

      - name: Ruff format check
        run: |
          set -o pipefail
          python -m ruff format --check src/ tests/ | tee .ci-logs/ruff-format.log

      - name: Mypy
        run: |
          set -o pipefail
          python -m mypy src/nexus_orchestrator/ | tee .ci-logs/mypy.log

      - name: Pytest (meta + unit + integration + smoke)
        run: |
          set -o pipefail
          python -m pytest tests/meta tests/unit tests/integration tests/smoke -v \
            | tee .ci-logs/pytest.log

      - name: Upload failure logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-failure-logs-${{ github.run_id }}-${{ github.run_attempt }}
          path: .ci-logs/
          if-no-files-found: ignore
          retention-days: 3
